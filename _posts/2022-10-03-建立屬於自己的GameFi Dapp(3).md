建立屬於自己的GameFi Dapp(3/7)
=======================

撰寫遊戲smart contract
------------------

文章目錄
----

1.  遊戲概念
2.  遊戲流程
3.  遊戲合約介紹
4.  發布及測試遊戲合約
5.  和NFT合約互動
6.  系列文章目錄

1\. 遊戲概念
--------

> King of the Ether

K[ing of the Ether](https://www.kingoftheether.com/thrones/kingoftheether/index.html)是一個藉由攻擊合約來獲取名譽和賞金的遊戲，smart contract會記錄王位擁有者和當前王位價值，遊戲一開始會將王位設置在0.5 Ether，當攻擊者投入0.5 Ether到smart contract就可以獲得王位，並且攻擊者的名字會被保留在區塊鏈當中。每一次的攻擊都必須支付比上一次王位價格多33%的費用，假設目前的國王是花費10 Ether當上王位，篡位者就必須支付13.3 Ether來取得王位，其中這13.3 Ether的大部分會補償給前一任國王，少部分傭金會給合約管理者。這樣的遊戲會一直持續，並且為了安全起見，篡位費到了100,000 Ether就不會上漲，如果超過14天沒有新國王出現，遊戲將會重新開始，但過去所有的國王將會繼續保留在區塊鏈當中。

![](https://miro.medium.com/max/1400/1*uKLMROnIOvbs_5LUpq9vNA.png)King of the Ether

King Of Ether目前沒有再繼續更新，因為合約本身有fallback函數的漏洞，會造成DoS的問題，因此不建議繼續投入Ether到這個合約。

> 新設計的遊戲

基於King of the Ether遊戲的啟發，以及近年來地標類型遊戲的興起，因此讓我萌生這個想法產生這個專案。可以將合約對應成一個地標，每當我們對合約進行攻擊時，其實就是對地標進行攻擊，King of the Ether原本的規則只能讓篡位者買下王位，但是新設計的地標遊戲可以讓擁有者進行防禦，因此遊戲的互動性更強也更為有趣。遊戲分為兩個不同陣營，每個陣營都可以為自己的陣營擴張領土 -- **透過打下地標的方式**，但是不論攻擊或防禦都必須支付一定的費用，費用將會累積至合約當中，直到地標被攻破，地標擁有的所有Ether和NFT將會作為獎勵給最後一個打下地標的人。地標有兩個重要的屬性 -- **生命和價值**，生命預設為100，價值預設為0，當地標的生命為0時，地標所有的價值就會轉給攻擊方，防守方在生命為0之前，都可以對地標進行防禦，當地標生命變為0，防守方就會轉換成攻擊方，想辦法將地標打下。

2\. 遊戲流程
--------

> 遊戲背景

在廣大的世界存在兩個古老的組織，這兩個陣營彼此互相爭奪領地，看誰是世界的統治者。

遊戲有兩個陣營，分別是藍色陣營和綠色陣營，每個玩家在創建角色時可以選擇要加入哪一個陣營，藍色陣營代表的是永恆，綠色陣營代表的是活力，同時，玩家可以選擇角色的職業，有魔法師、治療精靈、鬥士、劍士、弓箭手等。當註冊完成，玩家需要輸入錢包私鑰，用來和區塊鏈進行溝通，錢包內必須先存入ETH，因為mint NFT、攻擊和防守等動作都需要操作智慧合約，因此至少需要少許的手續費才能完成這些動作。

遊戲在進行的過程中會有兩種身分，分別是攻擊方和防守方，兩者最大的差別在於防守方擁有地標，而攻擊者則是要拿下地標。透過點選地標的詳細資訊可以知道這個地標是屬於哪一個陣營，如果是相同陣營，玩家可以選擇投入ETH來防禦地標；相反，如果是不同陣營，玩家可以投入ETH來成為地標擁有者。當玩家將一個地標打下後，他可以獲得地標上所有的ETH和NFT當作獎勵，但會扣除部分手續費。不論攻擊或防禦都會損失代幣，這些代幣都會存入合約當中，隨著時間增加，地標價值越高，因此會越容易被打下，加速地標國王的更替。

![](https://miro.medium.com/max/1400/1*RNDwgP-NGTBusdK1kYFcag.png)地標價值隨著時間增加

> 攻擊方

攻擊者可以使用兩種方式進行攻擊，第一種是利用ETH來發動攻擊，每次可以對地標發送<15 ETH的代幣來執行攻擊，當攻擊成立時，地標生命會減少，地標遊戲合約中的代幣池會存入攻擊的代幣，玩家可以持續攻擊直到地標生命為 0 ，攻擊行動就可以結束，同時，地標會記錄當前攻擊者為擁有者，並且攻擊者可以獲得當前地標所有ETH和NFT；第二種方式是透過NFT來攻擊，這種方式跟的第一種差不多，只是第一種限制最多只能攻擊15 ETH，而NFT攻擊的方式是透過NFT上metadata紀錄的價值來攻擊，攻擊者會先發送NFT給地標合約，當合約收到NFT後，玩家就可以發送等同NFT價值的ETH來攻擊，NFT的價值不等，但是一定會超過15 ETH，在攻擊的效率上會大大提升許多。

![](https://miro.medium.com/max/1400/1*H9iYAdBEM3FEtN5SuIagVg.png)攻擊

> 防守方

防守方是基於這個地標是屬於自己或相同陣營，防守者會為了維護地標尊嚴而進行攻防大戰，防守方可以攻擊也可以防守，可以根據策略來執行不同行為，當防守方需要進行防守，需要對地標注入小於等於15的ETH，防守成功後，地標生命會增加，而地標則會將防禦的ETH存入，因此地標價值會越來越高，這時候防守方可以考慮轉為攻擊方，重新奪下地標，回收所有獎勵；NFT的防禦和攻擊類似，同樣必須發送NFT給地標合約，並且注入等同NFT價值的ETH來防禦，而NFT價值會大於15，因此擁有更多NFT的玩家，在操作遊戲上會比其他玩家更容易防守或攻擊。

![](https://miro.medium.com/max/1400/1*7o96sSLpRb8dFFnKODvSwg.png)防禦

3\. 遊戲合約介紹
----------

完整遊戲合約可以參考[github](https://github.com/Yorkchung/GameFi_Contract)內的程式碼，以下會針對個別函數進行說明:

遊戲合約中會設置兩個struct，其中一個是**存地標資訊**，包含: 擁有者、地標NFT、生命、價值、所屬陣營、地理位置、攻擊NFT和防禦NFT等，以及是否已經初始化資訊；另一個是**儲存攻擊的歷史紀錄**，在app上可以看到這類資訊。

**遊戲開始前會預先將所有地標資訊輸入遊戲合約當中**，包含: 地標NFT、名稱、地理位置等，在初始化時會用mapping存入合約當中，mapping所使用的key是地標hash過後的值，hash方式是將地標經緯度經過加鹽後再進行sha1計算。所有地標位置都存於node.js所建立的API server當中，當app開啟地圖時會將API的地標和hash匯入，在對地標進行操作時就可以用hash知道是對應到哪一個地標合約。

地標的NFT合約地址、攻擊NFT合約地址，以及防禦NFT合約地址都可以被更改，但必須由**遊戲合約的擁有者**進行修改，一般使用者不能進行操作。

在對地標資訊進行修改時，會先判斷地標是否已經被初始化，如果地標已經存在，**遊戲合約擁有者**可以對資訊進行修改。

遊戲主體的部分是攻擊函數和防禦函數，發動攻擊時可以選擇使用ETH攻擊或是搭配NFT攻擊，兩者在遊戲合約中屬於兩種不同函數，函數中我設計使用ETH攻擊必須小於 0.15 ETH，也是就是 150,000,000,000,000,000 wei；而NFT攻擊必須先將NFT轉給合約才能進行攻擊，攻擊時，**遊戲合約會判斷這個NFT是否已經轉給遊戲合約**，如果成立，遊戲就會執行NFT上標註的價值的攻擊。**攻擊的勝利條件是必須完全剛好打下所有生命**，不能超過生命，例如: **生命100，不能使用超過1 ETH來攻擊**。

```
**攻擊必須小於 0.15 ETH**
```

**地標上標註的價值與ETH有所不同:**

```
**生命 1 = 價值 1 = 0.01 ETH  
生命 100 = 價值 100 = 1 ETH  
所以如果執行 0.1 ETH的攻擊，實際上是將生命扣 10，價值會增加 10。**
```

防禦函數與攻擊函數類似，都可以使用ETH防禦或搭配NFT來防禦，防禦時，最多只能將地標生命補滿，不能超過地標原有生命價值。而防禦函數和攻擊函數都會檢查是否是EOA帳戶才能進行操作。

4\. 發布及測試遊戲合約
-------------

測試合約的部分可以透過Remix來進行開發，發布時，建議先將合約上傳到ganache來測試功能是否正常，再上傳到公開測試網。

合約發布到Remix成功後，會看到下圖這些function，會看到我已經事先初始化一個名稱為123的地標。發佈到Ganache的部分可以參考上一篇，如何發布NFT。初始化時，必先先mint一個NFT給合約，並且在call initLankmark時指定NFT的編號。攻擊和防禦時必須傳入地標hash和ETH，當執行成功，地標的值就會跟著改變。如果是NFT攻擊就必須先轉NFT給合約，並且在攻擊時指定NFT的編號，讓遊戲合約確認。

![](https://miro.medium.com/max/956/1*4TnE_roSQh19Bx5UJriO-Q.png)Game(1/2)![](https://miro.medium.com/max/896/1*ZS_7OCVYSdq65zwzHeORlA.png)Game(2/2)

5\. 和NFT合約互動
------------

遊戲合約和NFT密切相關，因為遊戲會使用到地標NFT、攻擊NFT，以及防禦NFT，所以必須先發布三個NFT合約，下圖我發布了一個遊戲合約和三個YORKMETA的NFT合約。在遊戲發布後必須先將地標、攻擊和防禦的NFT address設定為我發布的這三個address。設定完成後，根據地標數量mint 地標NFT，這邊我mint 5 個地標NFT，然後我將第1個NFT，也就是編號 0 的NFT轉給遊戲合約，這樣遊戲地標在初始化時，就可以用編號 0 的NFT來建立地標參數。

> 為甚麼需要攻擊和防禦NFT的address?

因為攻擊時會將NFT傳給遊戲合約，遊戲合約會檢查NFT是誰傳給他的，並且遊戲合約會記錄NFT是屬於哪一個地標，防禦時也是相同道理。最後攻擊成功時，遊戲合約會吐出這個地標所有的NFT，除了地標本身的NFT，這個NFT會被轉給新的地標擁有者。

![](https://miro.medium.com/max/888/1*RpgjQZOmv3mrYMSRybMTRg.png)contract![](https://miro.medium.com/max/908/1*KYi6zmaQqYkwEqOd_Mr1cQ.png)NFT(1/2)![](https://miro.medium.com/max/902/1*AyvQFxLw2yn8Bh323yDlIw.png)NFT(2/2)

6\. 系列文章目錄
----------

文章會分成7個系列來介紹，分別針對用到的工具和方法進行介紹。文章目錄如下:

1.  [介紹GameFi以及如何部屬自己的GameFi](https://yorkisinhere.medium.com/gamefi-dapp-c840acd167c)
2.  [撰寫NFT合約](https://yorkisinhere.medium.com/e48b61a473bb)
3.  [撰寫地標合約](https://medium.com/@yorkisinhere/8f6eedded3d0)
4.  android功能
5.  node.js API和MongoDB
6.  IPFS
7.  使用web3j呼叫智慧合約功能
